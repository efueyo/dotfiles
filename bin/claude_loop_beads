#!/bin/bash
# Run claude in a loop for beads-tracked work

set -e

# Find claude binary
if command -v claude &>/dev/null; then
    CLAUDE_BIN="claude"
elif [[ -x "$HOME/.claude/local/claude" ]]; then
    CLAUDE_BIN="$HOME/.claude/local/claude"
else
    echo "Error: claude not found in PATH or ~/.claude/local/"
    exit 1
fi

# Color codes
RESET='\033[0m'
BOLD='\033[1m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
CYAN='\033[0;36m'
RED='\033[0;31m'

# Get the plan directory
if [[ -n "$1" ]]; then
    PLAN_DIR="$1"
else
    if [[ ! -d "./dev/active" ]]; then
        echo -e "${RED}Error: ./dev/active directory not found${RESET}"
        exit 1
    fi
    PLAN_DIR=$(find ./dev/active -mindepth 1 -maxdepth 1 -type d | fzf --prompt="Select plan: ")
    if [[ -z "$PLAN_DIR" ]]; then
        echo "No plan selected"
        exit 0
    fi
fi

PROMPT_FILE="$PLAN_DIR/prompt.md"
if [[ ! -f "$PROMPT_FILE" ]]; then
    echo -e "${RED}Error: prompt.md not found in $PLAN_DIR${RESET}"
    exit 1
fi

echo -e "${BOLD}${CYAN}Plan:${RESET} $PLAN_DIR"
echo ""

iteration=0
while true; do
    # Check if there's ready work
    READY=$(bd ready 2>/dev/null | grep -c 'bd-' || true)
    if [[ "$READY" -eq 0 ]]; then
        echo -e "${GREEN}No more ready tasks. All done!${RESET}"
        break
    fi

    iteration=$((iteration + 1))
    echo -e "${BOLD}${YELLOW}════════════════════════════════════════${RESET}"
    echo -e "${BOLD}${YELLOW}Iteration $iteration${RESET}"
    echo -e "${BOLD}${YELLOW}════════════════════════════════════════${RESET}"

    cat "$PROMPT_FILE" | "$CLAUDE_BIN" -p --verbose --output-format stream-json --dangerously-skip-permissions | parse_claude_output

    bd stats 2>/dev/null || true
    echo ""
done

echo -e "${BOLD}${GREEN}Loop finished!${RESET}"
bd stats
